import*as THREE from"./lib/three.module.js";import{MMDLoader}from"./lib/loaders/MMDLoader.js";import{MMDAnimationHelper}from"./lib/animation/MMDAnimationHelper.js";const WIDTH=2e3,HEIGHT=913;window.onload=()=>{Ammo().then((async e=>{Ammo=e;const o=new THREE.Clock,i=new THREE.Scene,t=new THREE.PerspectiveCamera(45,2e3/913,.1,1e3),a=new THREE.WebGLRenderer({antialias:!0});a.setSize(2e3,913),a.setClearColor(new THREE.Color(7232347)),a.setPixelRatio(window.devicePixelRatio),a.shadowMap.type=THREE.VSMShadowMap,a.shadowMapEnabled=!0,THREE.Cache.enabled=!0;const n=new THREE.DirectionalLight(4473924,1,100);n.position.set(35,50,60),n.castShadow=!0,n.shadow.mapSize.width=4e3,n.shadow.mapSize.height=4e3,n.shadow.camera.left=-50,n.shadow.camera.right=50,n.shadow.camera.top=-50,n.shadow.camera.bottom=50,n.shadow.bias=-5e-4,i.add(n),t.position.set(0,11,35),t.lookAt(new THREE.Vector3(0,11,0));const s=new THREE.AmbientLight(11775903);i.add(s);const l=new THREE.GridHelper(400,40,15066597,15066597);l.visible=!1,i.add(l),i.fog=new THREE.Fog(16777215,75,150);const d=new MMDLoader,r=(e,o,i,t)=>new Promise(((a,n)=>{d.loadWithAnimation(e,o,(e=>{const o=e.mesh,n=e.animation;o.rotation.set(i.rotate[0]*Math.PI,i.rotate[1]*Math.PI,i.rotate[2]*Math.PI),o.position.set(i.position[0],i.position[1],i.position[2]);const s=new MMDAnimationHelper({afterglow:2});return s.enable("physics",t.isPhysics),s.enable("ik",t.isIK),s.add(o,{animation:n,physics:t.isPhysics}),a({model:o,clip:n,helper:s})}),(e=>console.log(e)),(e=>n(e)))})),m=await r("mmdfile/houshou_marine/marin.pmx","vmdfile/motion.vmd",{rotate:[0,0,0],position:[0,0,0]},{isPhysics:!0,isIK:!1}),p=await r("mmdfile/ShiniNet/ShiniNet.pmx","vmdfile/renai_circulation1.vmd",{rotate:[0,0,0],position:[10,0,0]},{isPhysics:!0,isIK:!0});i.add(m.model),i.add(p.model);const c=m.helper.objects.get(m.model).mixer.stopAllAction().clipAction(m.clip),h=p.helper.objects.get(p.model).mixer.stopAllAction().clipAction(p.clip),w=await(E="vmdfile/camera.vmd",new Promise(((e,o)=>{d.loadAnimation(E,t,(o=>{const i=new MMDAnimationHelper;return i.add(t,{animation:o}),e({helper:i,clip:o})}),null,(e=>o(e)))})));var E;const u=w.helper.objects.get(t).mixer.stopAllAction().clipAction(w.clip),H=await(M="audioFile/stillDRE.mp3",new Promise(((e,o)=>{const i=new THREE.AudioListener,t=new THREE.Audio(i);(new THREE.AudioLoader).load(M,(o=>(t.setBuffer(o),t.setVolume(.5),t.setLoop(!0),e({sound:t}))),null,(e=>o(e)))})));var M;t.add(H.sound.listener);const A=await(R="mmdFile/YaMuDaoHeShenSe/models/autumn-standalone.pmx",P={rotate:[0,0,0],position:[0,0,0]},new Promise(((e,o)=>{d.load(R,(o=>(o.rotation.set(P.rotate[0]*Math.PI,P.rotate[1]*Math.PI,P.rotate[2]*Math.PI),o.position.set(P.position[0],P.position[1],P.position[2]),e({model:o}))),null,(e=>o(e)))})));var R,P;i.add(A.model),document.getElementById("mycanvas").appendChild(a.domElement);const T=function(){H.sound.isPlaying||H.sound.play();const e=o.getDelta();l.visible=!0,c.play(),h.play(),u.play(),m.helper.update(e),p.helper.update(e),w.helper.update(e),a.render(i,t),requestAnimationFrame(T)};T()}))};